services:
  # Default development service (headless, no GUI)
  ros2-vision:
    build:
      context: .
      dockerfile: Dockerfile
    image: ros2-vision:humble
    container_name: ros2-vision-dev
    
    # Use host network for ROS2 DDS communication
    network_mode: host
    
    # Privileged mode for hardware access (cameras, serial ports, CAN)
    privileged: true
    
    # Add video and render groups for GPU access
    group_add:
      - "44"   # video group
      - "109"  # render group
    
    # IMPORTANT: Entrypoint to create symlinks and setup environment
    entrypoint: ["/docker-entrypoint.sh"]
    command: ["sleep", "infinity"]
    
    # Environment variables
    environment:
      - ROS_DOMAIN_ID=0
      # OpenVINO environment
      - OPENVINO_DIR=/opt/intel/openvino_2024
      # Force use system Python (not Anaconda from host)
      - PYTHON_EXECUTABLE=/usr/bin/python3
      - Python3_EXECUTABLE=/usr/bin/python3
      # Prevent CMake from finding host's Anaconda
      - PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      # 大恒相机 GenTL 路径
      - GENICAM_GENTL64_PATH=/opt/Galaxy_camera/lib/x86_64
      - LD_LIBRARY_PATH=/opt/Galaxy_camera/lib/x86_64:/usr/lib:/usr/local/lib
    
    # Volume mounts - 挂载当前目录到 /ros2_ws
    volumes:
      # 挂载当前目录（ws）到 /ros2_ws
      - ./:/ros2_ws:rw
      # 构建产物使用 Docker volumes（提高性能）
      - ros2_build_cache:/ros2_ws/build
      - ros2_install_cache:/ros2_ws/install
      - ros2_log_cache:/ros2_ws/log
      # 大恒相机 SDK
      - /home/hustlyrm/drivers/Galaxy_Linux-x86_Gige-U3_32bits-64bits_1.5.2303.9221/Galaxy_camera:/opt/Galaxy_camera:ro
      - /usr/lib/libgxiapi.so:/usr/lib/libgxiapi.so:ro
      # Ceres Solver 本地缓存
      - /home/hustlyrm/repos/ceres-solver-2.2.0/include/ceres:/usr/local/include/ceres:ro
      - /home/hustlyrm/repos/ceres-solver-2.2.0/build/lib/libceres.a:/usr/local/lib/libceres.a:ro
      - /dev/bus/usb:/dev/bus/usb:rw
    
    # Device access
    devices:
      # Intel GPU for OpenVINO
      - /dev/dri:/dev/dri
    
    # Interactive terminal
    stdin_open: true
    tty: true
    
    # Working directory
    working_dir: /ros2_ws

  # GUI-enabled service (optional, for visualization)
  ros2-vision-gui:
    extends:
      service: ros2-vision
    container_name: ros2-vision-gui
    
    # Additional environment for X11
    environment:
      - ROS_DOMAIN_ID=0
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    
    # Additional volumes for X11
    volumes:
      - ./:/ros2_ws:rw
      - ros2_build_cache:/ros2_ws/build
      - ros2_install_cache:/ros2_ws/install
      - ros2_log_cache:/ros2_ws/log
      - /tmp/.X11-unix:/tmp/.X11-unix:rw

  # Hardware testing service with full device access
  ros2-vision-hardware:
    extends:
      service: ros2-vision
    container_name: ros2-vision-hardware
    
    # Full device access for hardware testing
    volumes:
      - ./:/ros2_ws:rw
      - ros2_build_cache:/ros2_ws/build
      - ros2_install_cache:/ros2_ws/install
      - ros2_log_cache:/ros2_ws/log
      - /dev:/dev:rw

# Named volumes for build cache persistence
volumes:
  ros2_build_cache:
  ros2_install_cache:
  ros2_log_cache:
