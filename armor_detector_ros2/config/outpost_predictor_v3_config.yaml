# ==============================================================================
# 前哨站预测器 V3 配置文件
# ==============================================================================
# 
# V3版本核心改进:
#   1. 使用极坐标观测模型 (yaw, pitch, distance, orientation)
#   2. 正确的多假设跟踪与收敛
#   3. 支持装甲板切换检测与处理
#   4. 参考rm.cv.fans的direct/indirect瞄准策略
#
# 坐标系约定 (相机坐标系):
#   - X轴: 向右
#   - Y轴: 向下
#   - Z轴: 向前 (光轴方向)
#
# 前哨站几何 (从上往下看顺时针方向):
#   - 三装甲板按顺时针排列: Low -> Middle -> High
#   - θ_center = 0 时，High装甲板正对相机
#   - ω > 0: 逆时针旋转
#
# ==============================================================================

outpost_predictor_v3:
  ros__parameters:
    
    # ==========================================================================
    # 几何参数 - 根据实际前哨站尺寸设置
    # ==========================================================================
    
    # 装甲板到转轴的水平距离 (米)
    # 标准前哨站: 0.2767m
    geometry.radius: 0.2767
    
    # 相邻装甲板的高度差 (米)
    # 最高板比中间板高 height_diff，最低板比中间板低 height_diff
    # 根据实测: 最高与最低相差200mm -> height_diff = 0.10m
    geometry.height_diff: 0.10
    
    # 装甲板与地面的夹角 (弧度)
    # 75° ≈ 1.309 rad，表示装甲板略微朝下
    geometry.tilt_angle: 1.309
    
    # ==========================================================================
    # 运动参数
    # ==========================================================================
    
    # 是否使用固定角速度
    # true (推荐): 前哨站角速度已知且固定
    # false: 让EKF估计角速度 (适用于变速前哨站)
    use_fixed_omega: true
    
    # 已知角速度 (rad/s)
    # 标准前哨站: 0.4转/秒 = 0.8π ≈ 2.513 rad/s
    known_omega: 2.5133
    
    # 角速度阈值 (rad/s)
    # 低于此值认为静止
    omega_threshold: 0.3
    
    # ==========================================================================
    # EKF噪声参数 - 调参关键
    # ==========================================================================
    # 
    # 过程噪声 (Q矩阵):
    #   - 越大: 跟踪响应快，但可能不稳定
    #   - 越小: 跟踪稳定，但可能滞后
    #
    # 观测噪声 (R矩阵):
    #   - 越大: 更信任模型，观测影响小
    #   - 越小: 更信任观测，跟踪更敏感
    # ==========================================================================
    
    # --- 过程噪声 ---
    # 角度过程噪声 (rad²)
    noise.q_theta: 0.01
    
    # 角速度过程噪声 (rad²/s²)
    noise.q_omega: 0.001
    
    # 位置过程噪声 (m²)
    noise.q_position: 0.001
    
    # --- 观测噪声 ---
    # 方位角观测噪声 (rad²) - 水平角
    noise.r_yaw: 0.01
    
    # 俯仰角观测噪声 (rad²) - 垂直角
    noise.r_pitch: 0.01
    
    # 距离观测噪声 (m²)
    noise.r_distance: 0.01
    
    # 装甲板朝向观测噪声 (rad²)
    noise.r_orientation: 0.05
    
    # ==========================================================================
    # 子弹和延迟参数
    # ==========================================================================
    
    # 子弹速度 (m/s)
    bullet_speed: 28.0
    
    # 系统总延迟 (秒)
    # 包括: 图像采集 + 网络传输 + 处理 + 电机响应
    system_delay: 0.05
    
    # ==========================================================================
    # 瞄准参数
    # ==========================================================================
    
    # 最大可击打朝向角 (弧度)
    # 装甲板与视线夹角小于此值时可击打
    # 60° ≈ 1.047 rad
    max_shootable_angle: 1.047
    
    # ==========================================================================
    # 多假设跟踪参数
    # ==========================================================================
    
    # 收敛阈值
    # 最佳假设置信度超过此值时认为收敛
    hypothesis_converge_threshold: 0.8
    
    # 收敛所需最小更新次数
    min_updates_to_converge: 15
    
    # 卡方检验阈值 (自由度=4)
    # 95% 置信区间: 9.49
    # 90% 置信区间: 7.78
    chi_square_threshold: 9.49
    
    # 装甲板切换检测的角度阈值 (弧度)
    # 当相邻帧orientation跳变超过此值，认为切换了装甲板
    # 60° ≈ 1.047 rad
    switch_angle_threshold: 1.047
    
    # ==========================================================================
    # 丢失与重置参数
    # ==========================================================================
    
    # 最大丢失帧数
    # 超过此帧数没有观测则考虑重置
    max_lost_frames: 30

# ==============================================================================
# V3 调参指南
# ==============================================================================
#
# 1. 首先确保几何参数正确
#    - geometry.radius: 实测装甲板到转轴距离
#    - geometry.height_diff: 实测最高与中间装甲板高度差
#    - 这两个参数直接影响多假设的区分
#
# 2. 验证运动参数
#    - 观察前哨站转一圈的时间 T
#    - known_omega = 2π / T
#    - 如果前哨站匀速旋转，设 use_fixed_omega: true
#
# 3. 观察收敛情况
#    - 正常应在10-20帧内收敛
#    - 如果不收敛，检查几何参数是否正确
#    - 或适当增大 hypothesis_converge_threshold
#
# 4. 调整噪声参数
#    - 如果跟踪抖动: 增大 r_* (观测噪声)
#    - 如果跟踪滞后: 增大 q_* (过程噪声)
#    - 如果角度跟不上: 增大 q_theta
#
# 5. 调整瞄准参数
#    - max_shootable_angle: 根据击打精度调整
#    - 值越大，可射击窗口越大，但命中率可能下降
#
# ==============================================================================
