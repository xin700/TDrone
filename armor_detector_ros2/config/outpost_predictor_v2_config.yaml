# ==============================================================================
# 前哨站预测器V2配置文件
# ==============================================================================
# 说明：
#   - V2版本使用多假设跟踪，自动识别观测的是哪块装甲板
#   - 修改参数后需要重新启动节点
#   - 参数可通过命令行覆盖：--ros-args -p geometry.radius:=0.30
# ==============================================================================

outpost_predictor_v2:
  ros__parameters:
    
    # ==========================================================================
    # 几何参数配置
    # ==========================================================================
    # 这些参数定义了前哨站的物理几何结构
    
    # 装甲板到旋转中心轴的水平距离（米）
    # 说明：前哨站的3块装甲板围绕中心轴旋转，radius定义了装甲板到中心轴的距离
    # 调试方法：根据实测前哨站尺寸设置，一般为0.26~0.28米
    geometry.radius: 0.2767
    
    # 相邻装甲板的高度差（米）
    # 说明：3块装甲板高度不同，height_diff定义中间板到最高/最低板的高度差
    #      - 最高板高度 = 中间板高度 + height_diff
    #      - 最低板高度 = 中间板高度 - height_diff
    # 调试方法：
    #   1. 实测前哨站最高板和最低板的垂直距离（例如0.20米）
    #   2. height_diff = 实测距离 / 2 = 0.10米
    #   3. 如果收敛后高度预测不准，微调此参数（±0.01米）
    geometry.height_diff: 0.10
    
    # 装甲板与水平面的夹角（弧度）
    # 说明：装甲板可能不是完全垂直的，tilt_angle定义其倾斜角度
    #      - 90° (1.57 rad) = 完全垂直
    #      - 85° (1.48 rad) = 向内倾斜5°
    #      - 75° (1.31 rad) = 向内倾斜15°
    # 调试方法：一般前哨站装甲板接近垂直，使用85°即可，暂不建议调整
    geometry.tilt_angle: 1.309  # ~75度
    
    # ==========================================================================
    # 运动参数配置
    # ==========================================================================
    
    # 已知的前哨站角速度（弧度/秒）
    # 说明：标准前哨站旋转速度约为0.4转/秒 = 0.4 * 2π = 0.8π rad/s
    # 调试方法：
    #   1. 观察前哨站旋转一圈的时间（例如2.5秒）
    #   2. known_omega = 2π / 时间 = 2π / 2.5 ≈ 2.51 rad/s
    #   3. 如果前哨站变速旋转，设置use_fixed_omega为false让EKF自动估计
    known_omega: 2.5132  # 0.4 转/秒 = 0.8π
    
    # 是否使用固定角速度
    # true:  强制使用known_omega作为角速度（推荐，前哨站通常匀速）
    # false: 让EKF自动估计角速度（适用于变速前哨站）
    use_fixed_omega: true
    
    # 角速度阈值（弧度/秒）
    # 说明：当估计的角速度低于此阈值时，认为前哨站静止
    # 调试方法：保持默认值0.1即可
    omega_threshold: 0.1
    
    # ==========================================================================
    # 噪声参数配置（EKF调参）
    # ==========================================================================
    # 说明：这些参数影响EKF的收敛速度和稳定性
    #      - 过程噪声(process_*)越大，跟踪响应越快但越不稳定
    #      - 测量噪声(measurement_*)越大，越信任预测模型而非观测值
    
    # 位置过程噪声（米²）
    # 影响：中心位置(x_c, y_c, z_c)的变化速度
    # 调试方法：如果位置跟踪滞后，增大此值（0.001 → 0.01）
    noise.process_pos: 0.001
    
    # 角度过程噪声（弧度²）
    # 影响：旋转角度θ的变化速度
    # 调试方法：如果角度跟踪滞后，增大此值（0.01 → 0.1）
    noise.process_theta: 0.01
    
    # 角速度过程噪声（弧度²/秒²）
    # 影响：角速度ω的变化速度
    # 调试方法：如果use_fixed_omega=false且角速度估计不准，调整此值
    noise.process_omega: 0.001
    
    # 位置测量噪声（米²）
    # 影响：对装甲板位置观测的信任程度
    # 调试方法：
    #   - 如果位置抖动严重，增大此值（0.02 → 0.05）
    #   - 如果跟踪迟钝，减小此值（0.02 → 0.01）
    noise.measurement_pos: 0.02
    
    # 角度测量噪声（弧度²）
    # 影响：对装甲板朝向观测的信任程度
    # 调试方法：如果角度抖动严重，增大此值（0.05 → 0.1）
    noise.measurement_angle: 0.05
    
    # ==========================================================================
    # 子弹和延迟参数
    # ==========================================================================
    
    # 子弹初速（米/秒）
    # 说明：用于计算子弹飞行时间和提前量
    # 调试方法：根据实际发射机构测试结果设置（一般15-30 m/s）
    bullet_speed: 28.0
    
    # 系统延迟（秒）
    # 说明：从检测到发射的总延迟，包括：
    #      - 图像采集延迟
    #      - 网络传输延迟
    #      - 处理计算延迟
    #      - 电机响应延迟
    # 调试方法：
    #   1. 录制视频，标记检测时刻
    #   2. 记录实际发射时刻
    #   3. system_delay = 发射时刻 - 检测时刻
    #   4. 一般在30-100ms之间
    system_delay: 0.05  # 50ms
    
    # ==========================================================================
    # 瞄准和射击窗口参数
    # ==========================================================================
    
    # 最大可射击朝向角（弧度）
    # 说明：装甲板朝向与相机连线的最大夹角，超过此角度认为无法击中
    #      - 0.65 rad ≈ 37°
    #      - 装甲板朝向误差在±37°内时允许射击
    # 调试方法：根据射击精度调整
    #   - 提高命中率：减小此值（0.65 → 0.5）
    #   - 增加射击机会：增大此值（0.65 → 0.8）
    max_orientation_angle: 0.65  # ~37度
    
    # 卡方检验阈值
    # 说明：用于判断观测值是否异常
    #      - 阈值越大，越容易接受异常观测（跟踪鲁棒但可能跟丢）
    #      - 阈值越小，越容易拒绝异常观测（跟踪精确但可能误判）
    # 调试方法：
    #   - 如果经常误判观测为异常，增大此值（15.0 → 20.0）
    #   - 如果容易被干扰，减小此值（15.0 → 10.0）
    chi_square_threshold: 15.0
    
    # 方向检测所需的样本数
    # 说明：累积多少次观测后判断旋转方向（顺时针/逆时针）
    # 调试方法：保持默认值10即可，过小会误判，过大会延迟
    direction_detection_samples: 10
    
    # ==========================================================================
    # 重置和鲁棒性参数
    # ==========================================================================
    
    # 最大丢失帧数
    # 说明：连续多少帧没有观测时认为目标丢失
    # 调试方法：根据帧率调整
    #   - 30 FPS: max_lost_count = 30 相当于 1秒
    #   - 装甲板切换时会短暂丢失，建议设置较大值避免误重置
    max_lost_count: 30
    
    # 丢失后是否重置
    # true:  丢失后清空状态，下次观测重新初始化（不推荐！）
    # false: 丢失后继续预测，下次观测继续更新（推荐）
    # 说明：前哨站旋转时装甲板切换必然有短暂丢失，设置为false避免频繁重置
    # 调试方法：正常情况应设置为false，只有在多目标严重干扰时才考虑true
    reset_on_lost: false

# ==============================================================================
# 参数调试指南
# ==============================================================================
# 
# 1. 几何参数优先级最高
#    - 首先确保 geometry.radius 和 geometry.height_diff 准确
#    - 这两个参数直接影响多假设跟踪的收敛
#    - 建议：实际测量前哨站尺寸
# 
# 2. 运动参数其次
#    - 确保 known_omega 接近实际旋转速度
#    - 如果前哨站变速，设置 use_fixed_omega: false
# 
# 3. 噪声参数最后微调
#    - 先用默认值测试
#    - 如果抖动严重，增大测量噪声
#    - 如果跟踪滞后，增大过程噪声
# 
# 4. 实时调参方法
#    方法1：命令行覆盖（无需重启）
#      ros2 param set /outpost_predictor_v2 geometry.radius 0.28
#    
#    方法2：启动时指定
#      ros2 run armor_detector_ros2 outpost_predictor_node_v2 \
#        --ros-args -p geometry.radius:=0.28
#    
#    方法3：修改此配置文件后重启节点
# 
# 5. 监控收敛状态
#    订阅 /outpost_state_v2 话题，观察：
#    - converged: 是否收敛
#    - best_hypothesis_id: 最佳假设（0=High, 1=Middle, 2=Low）
#    - hypothesis_confidences: 3个假设的置信度
#    - 正常情况下应在10-30帧内收敛，某个假设置信度趋近1.0
# 
# ==============================================================================
