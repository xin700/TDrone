# ==============================================================================
# 前哨站预测器 V4 配置文件
# ==============================================================================
# 
# V4版本核心特性:
#   1. 基于长宽比的θ观测: θ_abs = arccos(aspect_ratio / 2.58)
#   2. 分阶段初始化: 方向→高度→θ→EKF
#   3. 5维状态空间EKF: [ang, ω, x_c, y_c, z_c]
#   4. 4维观测空间: [θ, x_w, y_w, z_w]
#
# 坐标系约定 (机架坐标系):
#   - X轴: 向右
#   - Y轴: 向前 (机头方向)
#   - Z轴: 向上 (重力反方向)
#
# 前哨站几何 (从上往下看顺时针方向):
#   - 三装甲板按顺时针排列: Low(0) -> Middle(1) -> High(2)
#   - 相邻装甲板高度差 100mm
#   - 旋转半径 276.7mm
#   - 标准角速度 0.8π rad/s
#
# ==============================================================================

outpost_predictor_v4:
  ros__parameters:
    
    # ==========================================================================
    # 几何参数 - 根据实际前哨站尺寸设置
    # ==========================================================================
    
    # 装甲板到转轴的水平距离 (米)
    # 标准前哨站: 0.2767m = 276.7mm
    geometry.radius: 0.2767
    
    # 相邻装甲板的高度差 (米)
    # 最高板比中间板高 100mm，最低板比中间板低 100mm
    geometry.height_diff: 0.10
    
    # 装甲板与地面的夹角 (度)
    # 75度表示装甲板略微朝下
    geometry.tilt_angle_deg: 75.0
    
    # 装甲板正对相机时的最大长宽比
    # 该值用于θ计算: θ_abs = arccos(aspect_ratio / max_aspect_ratio)
    geometry.max_aspect_ratio: 2.58
    
    # ==========================================================================
    # 运动参数
    # ==========================================================================
    
    # 标准角速度 (rad/s)
    # 前哨站: 0.4转/秒 = 0.8π ≈ 2.513 rad/s
    motion.standard_omega: 2.5133
    
    # ==========================================================================
    # 初始化参数
    # ==========================================================================
    
    # 方向初始化所需帧数
    # 观测10帧cx变化来判断旋转方向
    init.direction_frames: 30
    
    # cx变化阈值 (像素)
    # 用于判断是否有明显移动
    init.cx_change_threshold: 30.0
    
    # z坐标突变阈值 (米)
    # 用于检测装甲板切换
    init.z_jump_threshold: 0.14
    
    # ==========================================================================
    # 相位观测参数 - 用于θ计算
    # ==========================================================================
    
    # 平台区长宽比阈值
    # 长宽比超过此值认为进入平台区
    phase.plateau_threshold: 2.2
    
    # 平台区退出比例
    # 长宽比低于 plateau_threshold * plateau_exit_ratio 强制退出
    phase.plateau_exit_ratio: 0.80
    
    # 确认进入平台区的长宽比
    # 在平台区内，长宽比需要至少达到此值才算真正进入过
    phase.plateau_confirm_ratio: 2.4
    
    # ==========================================================================
    # EKF参数 - 调参关键
    # ==========================================================================
    
    # --- 后验误差协方差P初始化 ---
    # θ的初始方差 (度²)
    # 较大值表示对初始角度不确定
    ekf.sigma_theta_sq: 0.1
    
    # ω的初始方差 ((rad/s)²)
    # 较大值表示对初始角速度不确定
    ekf.sigma_omega_sq: 1.0
    
    # 位置的初始方差 (m²)
    # 较大值表示对初始位置不确定
    ekf.sigma_x_sq: 50.0
    ekf.sigma_y_sq: 50.0
    ekf.sigma_z_sq: 50.0
    
    # --- 过程噪声Q ---
    # 越大: 跟踪响应快，但可能不稳定
    # 越小: 跟踪稳定，但可能滞后
    ekf.q_theta: 1.0e-4   # θ过程噪声
    ekf.q_omega: 1.0e-2   # ω过程噪声
    ekf.q_x: 1.0          # x过程噪声
    ekf.q_y: 1.0          # y过程噪声
    ekf.q_z: 0.1          # z过程噪声
    
    # --- 观测噪声R ---
    # 越大: 更信任模型，观测影响小
    # 越小: 更信任观测，跟踪更敏感
    ekf.r_theta: 0.01     # θ观测噪声
    ekf.r_x: 0.01         # x观测噪声
    ekf.r_y: 0.01         # y观测噪声
    ekf.r_z: 0.01         # z观测噪声
    
    # ==========================================================================
    # 预瞄参数
    # ==========================================================================
    
    # 系统总延迟 (秒)
    # 包括: 图像采集 + 处理 + 通信 + 电机响应
    # 需要根据实际系统测量调整
    aim.t_delay: 0.05
    
    # 子弹速度 (m/s)
    # 根据实际弹速设置
    aim.v_bullet: 28.0
    
    # 瞄准角阈值 (度)
    # 预瞄位置超过此角度则切换到下一个装甲板
    aim.angle_threshold_deg: 55.0
    
    # ==========================================================================
    # 收敛参数
    # ==========================================================================
    
    # EKF收敛所需帧数
    # EKF运行超过此帧数后认为收敛
    converge.ekf_frames: 50
    
    # 高度状态机验证帧数
    # 收敛后检查状态机与EKF高度状态是否一致
    converge.height_verify_frames: 10
    
    # 高度观测恢复等待帧数
    # 与EKF同步后，等待此帧数恢复正常观测模式
    converge.height_recovery_frames: 20

# ==============================================================================
# V4 调参指南
# ==============================================================================
#
# 1. 首先确保几何参数正确
#    - geometry.radius: 实测装甲板到转轴距离
#    - geometry.height_diff: 实测最高与中间装甲板高度差
#    - geometry.max_aspect_ratio: 通过实验测量装甲板正对时的长宽比
#
# 2. 验证初始化参数
#    - init.z_jump_threshold: 如果装甲板切换检测不稳定，尝试调整
#    - init.direction_frames: 可以增加以提高方向判断准确性
#
# 3. 调整相位观测参数
#    - phase.plateau_threshold: 根据实际长宽比分布调整
#    - 如果平台区检测不准确，可以调整相关阈值
#
# 4. EKF调参
#    - 如果跟踪抖动: 增大观测噪声 r_*
#    - 如果跟踪滞后: 增大过程噪声 q_*
#    - 如果角度跟不上: 增大 q_theta
#    - 如果位置估计飘: 减小 q_x, q_y
#
# 5. 预瞄调参
#    - aim.t_delay: 通过打靶测试确定，过小会提前量不足，过大会过度补偿
#    - aim.angle_threshold_deg: 根据击打精度调整，值越大可射击窗口越大
#
# ==============================================================================
